<h1>映画詳細</h1>

<div class="col-md-5">
  <%= attachment_image_tag @movie, :movie_image, size: "300x420", format: "jpg", fallback: "no_image.jpg" %><br/>
  総合スコア<br/>
  <p id='star-average-rate-<%= @movie.id %>'></p><%= @movie.reviews.average(:rate).to_f.round(1) %><br/>
   口コミ<%= @movie.reviews.count %> 件<br/>
  <% if user_signed_in? %>
    <%= link_to 'レビューを投稿する', new_user_movie_review_path(@movie) %>
  <% end %>
</div>
<div class="col-md-7">
  <h2><%= @movie.title %></h2><br/>

  <div class="box" >
    <h4>上映日:</h4><div class="text"><%= @movie.a_movie_released %></div><h4>上映時間:</h4><div class="text"><%= @movie.show_time %></div>
  </div><br/>

  <div class="box">
    <h4>ジャンル</h4>
    <% @movie.movie_genres.each do |movie_genre| %>
      <div class="text">:<%= movie_genre.genre.name %></div>
    <% end %>
  </div><br/>

  <h4>あらすじ</h4>
  <div><%= @movie.summary %></div><br/>

  <h4>監督</h4>
  <% @movie.supervisers.each do |superviser| %>
    <div><%= superviser.superviser_name %></div>
  <% end %><br/>

  <h4>脚本</h4>
  <% @movie.writers.each do |writer| %>
    <div><%= writer.writer_name %></div>
  <% end %><br/>

  <h4>キャスト</h4>
  <% @movie.actors.each do |actor| %>
    <div><%= actor.actor_name %></div>
  <% end %><br/>
</div>


<div class= "col-md-12">
  <% @reviews.each do |review| %>
  <div class="review">
    <div class="review-box">
      <ul class="review-mini-box">
        <li><%= attachment_image_tag review.user, :profile_image, size: "150x150", format: "jpg", fallback: "no_image.jpg" %></li>
        <li>
          <% if user_signed_in? %>
            <% if review.user.id == current_user.id %>
              <%= link_to 'レビューを編集する', edit_user_movie_review_path(@movie, review) %><br/>
              <%= link_to 'マイページへいく', user_user_path(current_user.id) %>
            <% else %>
              <%= link_to user_user_path(review.user.id) do %>
                <%= review.user.name %>さんのページへ行く
              <% end %>
            <% end %>
          <% end %>
        </li>
      </ul>
      <ul class="review-mini-box">
        <li><%= review.user.name%>さんの感想と評価。</li>
        <li><%= review.created_at %></li>
        <li id="star-rate-<%= review.id %>"></li>
        <li><%= review.content %></li>
      </ul>
    </div>
    <div class= "favorite-and-comments-box">
      <% if user_signed_in? %>
          <div class="favorite-layouts" id="favorite-<%= review.id%>">
            <%= render 'user/favorites/favorite', review: review %>
          </div>
        <% end %>
    </div>
  </div>
  <% end %>
</div>


<script>
  $(document).ready(function() {
    <% @reviews.each do |review| %>
      $('#star-rate-<%= review.id %>').raty({
        score: <%= review.rate %>,
        size: 36,
        starOff: '<%= "#{asset_path('star-off.png')}" %>',
        starOn: '<%= "#{asset_path('star-on.png')}" %>',
        starHalf: '<%= "#{asset_path('star-half.png')}" %>',
        half: true,
        readOnly: true,
      });
    <% end %>

    $('#star-average-rate-<%= @movie.id %>').raty({
      score: '<%= "#{@movie.reviews.average(:rate).to_f.round(1)}" %>',
      size: 36,
      starOff: '<%= "#{asset_path('star-off.png')}" %>',
      starOn: '<%= "#{asset_path('star-on.png')}" %>',
      starHalf: '<%= "#{asset_path('star-half.png')}" %>',
      half: true,
      readOnly: true
      //注目ポイント↑ 平均点を算出し、round関数で切り上げ
    });
  });
</script>